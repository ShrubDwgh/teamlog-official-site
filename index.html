<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Gaming Clan | Premium System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            font-weight: 500;
            color: #FFD700;
        }

        /* Main App Container */
        #app {
            display: none;
            width: 100%;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: rgba(15, 12, 41, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #FFD700;
        }

        /* Header Actions */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-container {
            position: relative;
            cursor: pointer;
        }

        .notification-bell {
            font-size: 22px;
            color: #FFD700;
            transition: transform 0.3s ease;
        }

        .notification-bell:hover {
            transform: scale(1.1);
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff5252;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Content Container */
        .content-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #FFD700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            border: none;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2c3e50, #4a6572);
        }

        .btn-success {
            background: linear-gradient(45deg, #00b894, #00d2d3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff7675, #fd79a8);
        }

        .btn-warning {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
        }

        .btn-purple {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-control {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        .badge-leader {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
        }

        .badge-staff {
            background: linear-gradient(45deg, #E5E4E2, #C0C0C0);
            color: #000;
        }

        .badge-member {
            background: linear-gradient(45deg, #b9f2ff, #7fffd4);
            color: #000;
        }

        /* Custom Badges */
        .badge-vip {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #000;
        }

        .badge-premium {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
        }

        .badge-elite {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
        }

        .badge-legend {
            background: linear-gradient(45deg, #ff7675, #fd79a8);
            color: white;
        }

        .badge-custom {
            background: linear-gradient(45deg, #00b894, #00d2d3);
            color: #000;
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 12, 41, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 12px;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 10px;
            min-width: 60px;
            border: none;
            background: none;
            cursor: pointer;
        }

        .nav-item.active {
            background: rgba(106, 17, 203, 0.3);
            color: #FFD700;
            transform: translateY(-5px);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        /* Alert Messages */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: rgba(0, 184, 148, 0.2);
            border: 1px solid rgba(0, 184, 148, 0.3);
            color: #00b894;
        }

        .alert-danger {
            background: rgba(255, 82, 82, 0.2);
            border: 1px solid rgba(255, 82, 82, 0.3);
            color: #ff5252;
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table th {
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
            color: #FFD700;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #FFD700;
        }

        .stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Profile Avatar */
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            border: 3px solid rgba(255, 215, 0, 0.3);
            cursor: pointer;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Privacy Toggle */
        .privacy-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Chat System */
        .marketplace-chat {
            background: rgba(15, 12, 41, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 12px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        .message.sent {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            align-self: flex-end;
            margin-left: auto;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
            margin-right: auto;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .message-sender {
            font-weight: 600;
            color: #FFD700;
            cursor: pointer;
        }

        .message-sender:hover {
            text-decoration: underline;
        }

        .message-time {
            font-size: 12px;
            opacity: 0.7;
        }

        .message-content {
            line-height: 1.4;
        }

        .mention {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }

        .mention:hover {
            background: rgba(255, 215, 0, 0.3);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #6a11cb;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: rgba(15, 12, 41, 0.95);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            color: #FFD700;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Password Strength */
        .password-strength {
            margin-top: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .strength-weak { color: #ff5252; }
        .strength-fair { color: #ffb142; }
        .strength-good { color: #2ecc71; }
        .strength-strong { color: #27ae60; }

        /* Confirmation Dialog */
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .confirmation-dialog.active {
            display: flex;
        }

        .confirmation-content {
            background: rgba(15, 12, 41, 0.95);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .confirmation-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .content-container {
                padding: 15px;
                padding-bottom: 70px;
            }
            
            .card {
                padding: 20px;
            }
            
            .nav-text {
                display: none;
            }
            
            .nav-item {
                padding: 8px 10px;
                min-width: 50px;
            }
            
            .confirmation-buttons {
                flex-direction: column;
            }
            
            .header-actions {
                gap: 10px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            border-radius: 4px;
        }

        /* Fix untuk logout button */
        .logout-btn {
            background: linear-gradient(45deg, #ff7675, #fd79a8) !important;
            color: white !important;
            border: none;
            padding: 8px 16px !important;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            width: auto !important;
            margin: 0 !important;
        }

        .logout-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 118, 117, 0.4);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Loading Elite Gaming Clan...</div>
    </div>

    <!-- Main App -->
    <div id="app">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <i class="fas fa-crown"></i>
                <span>Elite Clan</span>
            </div>
            <div class="header-actions" id="headerActions"></div>
        </header>

        <!-- Main Content -->
        <main id="content" class="content-container"></main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav" id="bottomNav" style="display: none;"></nav>

        <!-- Transfer Modal -->
        <div class="modal-overlay" id="transferModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Transfer Team Cash</h3>
                    <button class="btn btn-danger" onclick="closeModal()" style="width: auto; padding: 8px 16px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="transferForm"></div>
            </div>
        </div>

        <!-- Nickname Modal -->
        <div class="modal-overlay" id="nicknameModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Berikan Julukan</h3>
                    <button class="btn btn-danger" onclick="closeNicknameModal()" style="width: auto; padding: 8px 16px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="nicknameForm"></div>
            </div>
        </div>

        <!-- Badge Modal -->
        <div class="modal-overlay" id="badgeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Berikan Custom Badge</h3>
                    <button class="btn btn-danger" onclick="closeBadgeModal()" style="width: auto; padding: 8px 16px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="badgeForm"></div>
            </div>
        </div>

        <!-- Confirmation Dialog -->
        <div class="confirmation-dialog" id="logoutConfirmation">
            <div class="confirmation-content">
                <h3 style="margin-bottom: 20px; color: #FFD700;">Logout</h3>
                <p>Apakah Anda yakin ingin logout?</p>
                <div class="confirmation-buttons">
                    <button class="btn btn-danger" onclick="confirmLogout()" style="width: auto;">
                        Ya, Logout
                    </button>
                    <button class="btn btn-secondary" onclick="cancelLogout()" style="width: auto;">
                        Tidak
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Element for Water Drop Sound -->
    <audio id="waterDropSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-water-drop-773.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ============================================
        // DATABASE SYSTEM
        // ============================================

        const Database = {
            init() {
                if (!localStorage.getItem('eliteClanDB')) {
                    const defaultData = {
                        users: [
                            {
                                id: 1,
                                gamertag: 'AdminLeader',
                                discord: 'leader#0001',
                                whatsapp: '+628123456789',
                                password: 'admin123',
                                role: 'leader',
                                createdAt: new Date().toISOString(),
                                lastLogin: new Date().toISOString(),
                                teamCash: 0,
                                tapCount: 0,
                                nickname: '',
                                customBadge: null,
                                about: 'Clan Founder & Leader',
                                profileImage: null,
                                privacy: {
                                    whatsapp: true,
                                    discord: true,
                                    about: true
                                }
                            },
                            {
                                id: 2,
                                gamertag: 'EliteMember',
                                discord: 'member#0002',
                                whatsapp: '+628987654321',
                                password: 'member123',
                                role: 'member',
                                createdAt: new Date().toISOString(),
                                lastLogin: new Date().toISOString(),
                                teamCash: 0,
                                tapCount: 0,
                                nickname: '',
                                customBadge: null,
                                about: 'Active player looking for challenges',
                                profileImage: null,
                                privacy: {
                                    whatsapp: true,
                                    discord: true,
                                    about: true
                                }
                            }
                        ],
                        tokens: [
                            {
                                id: 1,
                                token: 'ELITE2024',
                                createdBy: 1,
                                used: false,
                                usedBy: null,
                                createdAt: new Date().toISOString()
                            }
                        ],
                        messages: [],
                        notifications: [],
                        purchaseRequests: [],
                        badgePurchases: [],
                        settings: {
                            soundEnabled: true,
                            volume: 0.8
                        }
                    };
                    localStorage.setItem('eliteClanDB', JSON.stringify(defaultData));
                }
                return this.getData();
            },

            getData() {
                try {
                    return JSON.parse(localStorage.getItem('eliteClanDB') || '{}');
                } catch (e) {
                    console.error('Database error:', e);
                    return this.init();
                }
            },

            saveData(data) {
                localStorage.setItem('eliteClanDB', JSON.stringify(data));
            },

            // User Operations
            getUsers() {
                return this.getData().users || [];
            },

            addUser(user) {
                const data = this.getData();
                if (!data.users) data.users = [];
                
                user.id = data.users.length ? Math.max(...data.users.map(u => u.id)) + 1 : 1;
                user.createdAt = new Date().toISOString();
                user.lastLogin = new Date().toISOString();
                user.teamCash = 0;
                user.tapCount = 0;
                user.nickname = '';
                user.customBadge = null;
                user.about = '';
                user.profileImage = null;
                user.privacy = {
                    whatsapp: true,
                    discord: true,
                    about: true
                };
                
                data.users.push(user);
                this.saveData(data);
                return user.id;
            },

            updateUser(id, updates) {
                const data = this.getData();
                const userIndex = data.users.findIndex(u => u.id === id);
                if (userIndex !== -1) {
                    data.users[userIndex] = { ...data.users[userIndex], ...updates };
                    this.saveData(data);
                    return true;
                }
                return false;
            },

            findUserByGamertag(gamertag) {
                return this.getUsers().find(u => u.gamertag === gamertag);
            },

            findUserById(id) {
                return this.getUsers().find(u => u.id === id);
            },

            // Tap System Operations
            addTap(userId) {
                const user = this.findUserById(userId);
                if (!user) return { success: false };
                
                user.tapCount = (user.tapCount || 0) + 1;
                
                const oldTaps = user.tapCount - 1;
                const oldTCFromTaps = Math.floor(oldTaps / 100) * 5;
                const newTCFromTaps = Math.floor(user.tapCount / 100) * 5;
                const tcEarned = newTCFromTaps - oldTCFromTaps;
                
                if (tcEarned > 0) {
                    user.teamCash += tcEarned;
                }
                
                this.updateUser(userId, {
                    tapCount: user.tapCount,
                    teamCash: user.teamCash
                });
                
                return { 
                    success: true, 
                    tapCount: user.tapCount,
                    tcEarned: tcEarned,
                    totalTC: user.teamCash
                };
            },

            // Token Operations
            getTokens() {
                return this.getData().tokens || [];
            },

            addToken(token) {
                const data = this.getData();
                if (!data.tokens) data.tokens = [];
                
                token.id = data.tokens.length ? Math.max(...data.tokens.map(t => t.id)) + 1 : 1;
                token.used = false;
                token.usedBy = null;
                token.createdAt = new Date().toISOString();
                data.tokens.push(token);
                this.saveData(data);
                return token.id;
            },

            validateToken(token) {
                const tokens = this.getTokens();
                const tokenObj = tokens.find(t => t.token === token);
                return tokenObj && !tokenObj.used;
            },

            markTokenUsed(token, userId) {
                const data = this.getData();
                const tokenIndex = data.tokens.findIndex(t => t.token === token);
                if (tokenIndex !== -1) {
                    data.tokens[tokenIndex].used = true;
                    data.tokens[tokenIndex].usedBy = userId;
                    data.tokens[tokenIndex].usedAt = new Date().toISOString();
                    this.saveData(data);
                    return true;
                }
                return false;
            },

            // Team Cash Operations
            transferCash(fromUserId, toUserId, amount, note = '') {
                const data = this.getData();
                const fromUser = data.users.find(u => u.id === fromUserId);
                const toUser = data.users.find(u => u.id === toUserId);
                
                if (!fromUser || !toUser) {
                    return { success: false, message: 'User not found' };
                }
                
                if (fromUser.teamCash < amount) {
                    return { success: false, message: 'Insufficient Team Cash' };
                }
                
                if (amount <= 0) {
                    return { success: false, message: 'Invalid amount' };
                }
                
                fromUser.teamCash -= amount;
                toUser.teamCash += amount;
                
                if (!data.transactions) data.transactions = [];
                data.transactions.push({
                    id: data.transactions.length + 1,
                    fromUserId,
                    toUserId,
                    amount,
                    note,
                    timestamp: new Date().toISOString()
                });
                
                this.saveData(data);
                
                this.addNotification({
                    userId: toUserId,
                    type: 'transfer_received',
                    fromUserId: fromUserId,
                    fromUserGamertag: fromUser.gamertag,
                    amount: amount,
                    message: `Anda menerima ${amount} TC dari ${fromUser.gamertag}`,
                    read: false,
                    timestamp: new Date().toISOString()
                });
                
                return { success: true, message: 'Transfer successful' };
            },

            // Purchase System
            addPurchaseRequest(request) {
                const data = this.getData();
                if (!data.purchaseRequests) data.purchaseRequests = [];
                
                request.id = data.purchaseRequests.length ? Math.max(...data.purchaseRequests.map(r => r.id)) + 1 : 1;
                request.status = 'pending';
                request.createdAt = new Date().toISOString();
                data.purchaseRequests.push(request);
                this.saveData(data);
                
                const leader = data.users.find(u => u.role === 'leader');
                if (leader) {
                    this.addNotification({
                        userId: leader.id,
                        type: 'purchase_request',
                        message: `${request.gamertag} ingin membeli ${request.amount} TC (Rp ${request.totalPrice.toLocaleString()})`,
                        read: false,
                        timestamp: new Date().toISOString()
                    });
                }
                
                return request.id;
            },

            getPurchaseRequests(userId = null) {
                const data = this.getData();
                if (!data.purchaseRequests) return [];
                if (userId) {
                    return data.purchaseRequests.filter(r => r.userId === userId);
                }
                return data.purchaseRequests;
            },

            updatePurchaseRequest(requestId, updates) {
                const data = this.getData();
                const request = data.purchaseRequests.find(r => r.id === requestId);
                if (request) {
                    Object.assign(request, updates);
                    this.saveData(data);
                    return true;
                }
                return false;
            },

            completePurchase(requestId) {
                const request = this.getPurchaseRequests().find(r => r.id === requestId);
                if (!request || request.status !== 'pending') return false;
                
                request.status = 'completed';
                request.completedAt = new Date().toISOString();
                
                const user = this.findUserById(request.userId);
                if (user) {
                    user.teamCash += request.amount;
                    this.updateUser(user.id, { teamCash: user.teamCash });
                    
                    this.addNotification({
                        userId: user.id,
                        type: 'purchase_completed',
                        message: `Pembelian ${request.amount} TC telah selesai diproses!`,
                        read: false,
                        timestamp: new Date().toISOString()
                    });
                }
                
                this.saveData(this.getData());
                return true;
            },

            // Badge Purchase System
            addBadgePurchase(purchase) {
                const data = this.getData();
                if (!data.badgePurchases) data.badgePurchases = [];
                
                purchase.id = data.badgePurchases.length ? Math.max(...data.badgePurchases.map(b => b.id)) + 1 : 1;
                purchase.status = 'pending';
                purchase.createdAt = new Date().toISOString();
                data.badgePurchases.push(purchase);
                this.saveData(data);
                
                if (purchase.type === 'custom') {
                    const leader = data.users.find(u => u.role === 'leader');
                    if (leader) {
                        this.addNotification({
                            userId: leader.id,
                            type: 'badge_request',
                            message: `${purchase.gamertag} ingin membeli custom badge "${purchase.badgeName}"`,
                            read: false,
                            timestamp: new Date().toISOString()
                        });
                    }
                } else {
                    this.completeBadgePurchase(purchase.id);
                }
                
                return purchase.id;
            },

            getBadgePurchases(userId = null) {
                const data = this.getData();
                if (!data.badgePurchases) return [];
                if (userId) {
                    return data.badgePurchases.filter(b => b.userId === userId);
                }
                return data.badgePurchases;
            },

            completeBadgePurchase(purchaseId) {
                const purchase = this.getBadgePurchases().find(b => b.id === purchaseId);
                if (!purchase || purchase.status !== 'pending') return false;
                
                purchase.status = 'completed';
                purchase.completedAt = new Date().toISOString();
                
                const user = this.findUserById(purchase.userId);
                if (user) {
                    user.customBadge = {
                        type: purchase.type,
                        name: purchase.badgeName,
                        color: purchase.badgeColor
                    };
                    this.updateUser(user.id, { customBadge: user.customBadge });
                    
                    this.addNotification({
                        userId: user.id,
                        type: 'badge_completed',
                        message: `Custom badge "${purchase.badgeName}" telah aktif!`,
                        read: false,
                        timestamp: new Date().toISOString()
                    });
                }
                
                this.saveData(this.getData());
                return true;
            },

            // Message Operations
            addMessage(message) {
                const data = this.getData();
                if (!data.messages) data.messages = [];
                
                message.id = data.messages.length ? Math.max(...data.messages.map(m => m.id)) + 1 : 1;
                message.timestamp = new Date().toISOString();
                message.read = false;
                data.messages.push(message);
                this.saveData(data);
                
                this.processMentions(message);
                
                return message.id;
            },

            getMessages() {
                return this.getData().messages || [];
            },

            getMarketplaceMessages() {
                return this.getMessages().filter(m => m.type === 'marketplace');
            },

            // Notification Operations
            addNotification(notification) {
                const data = this.getData();
                if (!data.notifications) data.notifications = [];
                
                notification.id = data.notifications.length ? Math.max(...data.notifications.map(n => n.id)) + 1 : 1;
                notification.timestamp = new Date().toISOString();
                notification.read = false;
                data.notifications.push(notification);
                this.saveData(data);
                return notification.id;
            },

            getNotifications(userId) {
                const data = this.getData();
                if (!data.notifications) return [];
                return data.notifications.filter(n => n.userId === userId && !n.read);
            },

            markNotificationRead(notificationId) {
                const data = this.getData();
                const index = data.notifications.findIndex(n => n.id === notificationId);
                if (index !== -1) {
                    data.notifications[index].read = true;
                    this.saveData(data);
                    return true;
                }
                return false;
            },

            markAllNotificationsRead(userId) {
                const data = this.getData();
                data.notifications.forEach(n => {
                    if (n.userId === userId) {
                        n.read = true;
                    }
                });
                this.saveData(data);
                return true;
            },

            processMentions(message) {
                const mentionRegex = /@(\w+)/g;
                const mentions = message.content.match(mentionRegex);
                
                if (mentions) {
                    mentions.forEach(mention => {
                        const username = mention.substring(1);
                        const mentionedUser = this.findUserByGamertag(username);
                        
                        if (mentionedUser && mentionedUser.id !== message.senderId) {
                            this.addNotification({
                                userId: mentionedUser.id,
                                type: 'mention',
                                fromUserId: message.senderId,
                                fromUserGamertag: message.senderName,
                                message: `Anda disebutkan oleh ${message.senderName} di marketplace chat`,
                                read: false,
                                timestamp: new Date().toISOString()
                            });
                        }
                    });
                }
            },

            getSettings() {
                return this.getData().settings || { soundEnabled: true, volume: 0.8 };
            },

            updateSettings(updates) {
                const data = this.getData();
                data.settings = { ...data.settings, ...updates };
                this.saveData(data);
                return true;
            }
        };

        // ============================================
        // SOUND SYSTEM
        // ============================================

        const SoundSystem = {
            volume: 0.8,
            enabled: true,

            init() {
                const settings = Database.getSettings();
                this.enabled = settings.soundEnabled;
                this.volume = settings.volume;
            },

            playClick() {
                if (!this.enabled) return;
                
                try {
                    const audio = document.getElementById('waterDropSound');
                    if (audio) {
                        audio.volume = this.volume;
                        audio.currentTime = 0;
                        audio.play().catch(e => console.log('Audio play failed:', e));
                    }
                } catch (e) {
                    console.log('Sound error:', e);
                }
            },

            updateSettings(enabled, volume) {
                this.enabled = enabled;
                this.volume = volume;
            }
        };

        // ============================================
        // APP STATE MANAGEMENT
        // ============================================

        const AppState = {
            currentUser: null,
            currentPage: 'home',
            currentSection: 'profile',
            viewingMemberId: null,
            tapCooldown: false,

            init() {
                try {
                    Database.init();
                    SoundSystem.init();
                    this.loadUserSession();
                    
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.opacity = '0';
                        setTimeout(() => {
                            document.getElementById('loadingScreen').style.display = 'none';
                            document.getElementById('app').style.display = 'block';
                            this.render();
                        }, 500);
                    }, 1000);
                    
                    this.setupClickSounds();
                    
                } catch (error) {
                    console.error('Init error:', error);
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    this.render();
                }
            },

            loadUserSession() {
                try {
                    const savedUser = sessionStorage.getItem('currentUser');
                    if (savedUser) {
                        this.currentUser = JSON.parse(savedUser);
                    }
                } catch (e) {
                    console.error('Session load error:', e);
                }
            },

            saveUserSession() {
                try {
                    if (this.currentUser) {
                        sessionStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    } else {
                        sessionStorage.removeItem('currentUser');
                    }
                } catch (e) {
                    console.error('Session save error:', e);
                }
            },

            setupClickSounds() {
                document.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' || 
                        e.target.tagName === 'A' || 
                        e.target.closest('button') || 
                        e.target.closest('a') ||
                        e.target.type === 'submit' ||
                        e.target.type === 'button') {
                        setTimeout(() => SoundSystem.playClick(), 10);
                    }
                });
            },

            navigate(page) {
                SoundSystem.playClick();
                this.currentPage = page;
                this.viewingMemberId = null;
                this.render();
            },

            navigateSection(section) {
                SoundSystem.playClick();
                this.currentSection = section;
                this.viewingMemberId = null;
                this.render();
            },

            viewMemberProfile(memberId) {
                SoundSystem.playClick();
                this.viewingMemberId = memberId;
                this.currentSection = 'view_profile';
                this.render();
            },

            render() {
                const content = document.getElementById('content');
                const bottomNav = document.getElementById('bottomNav');
                
                if (!content) return;

                try {
                    content.innerHTML = '';
                    
                    switch (this.currentPage) {
                        case 'home':
                            content.innerHTML = this.renderHome();
                            bottomNav.style.display = 'none';
                            break;
                        case 'login':
                            content.innerHTML = this.renderLogin();
                            bottomNav.style.display = 'none';
                            break;
                        case 'register':
                            content.innerHTML = this.renderRegister();
                            bottomNav.style.display = 'none';
                            break;
                        case 'dashboard':
                            content.innerHTML = this.renderDashboardContent();
                            this.renderBottomNav();
                            bottomNav.style.display = 'flex';
                            break;
                    }
                    
                    this.renderHeaderActions();
                } catch (error) {
                    console.error('Render error:', error);
                    content.innerHTML = '<div class="card"><h2>Error Loading Page</h2><p>Please refresh the page</p></div>';
                }
            },

            renderHeaderActions() {
                const headerActions = document.getElementById('headerActions');
                if (!headerActions) return;

                if (this.currentUser) {
                    const notifications = Database.getNotifications(this.currentUser.id);
                    const notificationCount = notifications.length;
                    
                    headerActions.innerHTML = `
                        <div class="notification-container" onclick="toggleNotifications()">
                            <i class="fas fa-bell notification-bell"></i>
                            ${notificationCount > 0 ? `<span class="notification-count">${notificationCount}</span>` : ''}
                        </div>
                        <div class="badge ${this.currentUser.role === 'leader' ? 'badge-leader' : 
                                          this.currentUser.role === 'staff' ? 'badge-staff' : 'badge-member'}"
                             style="margin-right: 10px;">
                            ${this.currentUser.role.toUpperCase()}
                        </div>
                        <button class="logout-btn" onclick="showLogoutConfirmation()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    `;
                } else {
                    headerActions.innerHTML = `
                        <button class="btn" onclick="AppState.navigate('login')" style="width: auto; padding: 8px 16px;">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    `;
                }
            },

            renderBottomNav() {
                const bottomNav = document.getElementById('bottomNav');
                if (!bottomNav) return;

                bottomNav.innerHTML = '';
                
                const navItems = [
                    { id: 'profile', icon: 'fa-user', label: 'Profil' },
                    { id: 'buy', icon: 'fa-shopping-cart', label: 'Beli TC' },
                    { id: 'market', icon: 'fa-coins', label: 'Market' },
                    { id: 'team', icon: 'fa-users', label: 'Team' },
                    { id: 'leaderboard', icon: 'fa-trophy', label: 'Ranking' }
                ];

                if (this.currentUser?.role === 'leader') {
                    navItems.push({ id: 'tokens', icon: 'fa-key', label: 'Tokens' });
                }

                navItems.forEach(item => {
                    const button = document.createElement('button');
                    button.className = `nav-item ${this.currentSection === item.id ? 'active' : ''}`;
                    button.innerHTML = `
                        <i class="fas ${item.icon} nav-icon"></i>
                        <span class="nav-text">${item.label}</span>
                    `;
                    button.onclick = () => {
                        SoundSystem.playClick();
                        this.currentSection = item.id;
                        this.viewingMemberId = null;
                        this.render();
                    };
                    bottomNav.appendChild(button);
                });
            },

            // =========== RENDER FUNCTIONS ===========

            renderHome() {
                return `
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 72px; margin-bottom: 20px; color: #FFD700;">
                            <i class="fas fa-crown"></i>
                        </div>
                        <h1 style="margin-bottom: 10px;">Elite Gaming Clan</h1>
                        <p style="margin-bottom: 30px; opacity: 0.8;">Premium clan management system</p>
                        
                        <div style="max-width: 400px; margin: 0 auto;">
                            <button class="btn" onclick="AppState.navigate('login')" style="margin-bottom: 15px;">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                            <button class="btn btn-secondary" onclick="AppState.navigate('register')">
                                <i class="fas fa-user-plus"></i> Register
                            </button>
                        </div>
                    </div>
                `;
            },

            renderLogin() {
                return `
                    <div style="max-width: 500px; margin: 0 auto;">
                        <button class="btn btn-secondary" onclick="AppState.navigate('home')" style="margin-bottom: 20px; width: auto;">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-lock"></i> Login
                            </div>
                            
                            <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                            
                            <form id="loginForm">
                                <div class="form-group">
                                    <label class="form-label">Gamertag</label>
                                    <input type="text" class="form-control" id="loginGamertag" placeholder="Enter gamertag" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword" placeholder="Enter password" required>
                                </div>
                                
                                <button type="button" class="btn" onclick="AppState.handleLogin()">
                                    <i class="fas fa-sign-in-alt"></i> Login
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            },

            renderRegister() {
                return `
                    <div style="max-width: 600px; margin: 0 auto;">
                        <button class="btn btn-secondary" onclick="AppState.navigate('home')" style="margin-bottom: 20px; width: auto;">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-user-plus"></i> Register
                            </div>
                            
                            <div id="registerError" class="alert alert-danger" style="display: none;"></div>
                            
                            <form id="registerForm">
                                <div class="form-group">
                                    <label class="form-label">Gamertag</label>
                                    <input type="text" class="form-control" id="registerGamertag" placeholder="Your gamertag" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Discord</label>
                                    <input type="text" class="form-control" id="registerDiscord" placeholder="username#0000" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">WhatsApp</label>
                                    <input type="text" class="form-control" id="registerWhatsapp" placeholder="+628123456789" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Invitation Token</label>
                                    <input type="text" class="form-control" id="registerToken" placeholder="Get from leader" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="registerPassword" placeholder="Min 8 characters" required oninput="checkPasswordStrength(this.value)">
                                    <div id="passwordStrength" class="password-strength"></div>
                                </div>
                                
                                <button type="button" class="btn btn-success" onclick="AppState.handleRegister()">
                                    <i class="fas fa-user-plus"></i> Register
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            },

            renderDashboardContent() {
                if (!this.currentUser) return '<p>Please login</p>';
                
                if (this.viewingMemberId) {
                    return this.renderMemberProfile(this.viewingMemberId);
                }
                
                switch (this.currentSection) {
                    case 'profile':
                        return this.renderProfile();
                    case 'buy':
                        return this.renderBuyTC();
                    case 'leaderboard':
                        return this.renderLeaderboard();
                    case 'tokens':
                        return this.renderTokens();
                    case 'market':
                        return this.renderMarket();
                    case 'team':
                        return this.renderTeam();
                    default:
                        return this.renderProfile();
                }
            },

            renderProfile() {
                const user = this.currentUser;
                const joinDate = new Date(user.createdAt).toLocaleDateString();
                const lastLogin = new Date(user.lastLogin).toLocaleDateString();
                const notifications = Database.getNotifications(user.id);
                const tapCount = user.tapCount || 0;
                const tcFromTaps = Math.floor(tapCount / 100) * 5;
                const tapProgress = tapCount % 100;

                return `
                    <div class="animate-fade-in">
                        ${notifications.length > 0 ? `
                            <div class="card" style="background: rgba(255, 215, 0, 0.1); border-color: rgba(255, 215, 0, 0.3);">
                                <div class="card-header">
                                    <i class="fas fa-bell"></i> Notifications (${notifications.length})
                                    <button class="btn btn-secondary" onclick="markAllNotificationsRead()" style="margin-left: auto; width: auto; padding: 5px 10px; font-size: 12px;">
                                        Mark all as read
                                    </button>
                                </div>
                                <div>
                                    ${notifications.map(notif => `
                                        <div style="padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <div style="display: flex; justify-content: space-between;">
                                                <span>${notif.message}</span>
                                                <button class="btn btn-secondary" onclick="markNotificationRead(${notif.id})" style="width: auto; padding: 5px 10px; font-size: 12px;">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            </div>
                                            <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                                                ${new Date(notif.timestamp).toLocaleString()}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="card" style="text-align: center;">
                            <div class="profile-avatar" onclick="uploadProfileImage()">
                                ${user.profileImage ? 
                                    `<img src="${user.profileImage}" alt="Profile">` : 
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                            <h2 style="margin-bottom: 5px;">${user.nickname || user.gamertag}</h2>
                            <div style="margin-bottom: 10px;">
                                ${user.customBadge ? 
                                    `<span class="badge" style="background: ${user.customBadge.color}; color: ${user.customBadge.type === 'custom' ? '#000' : 'white'}">
                                        ${user.customBadge.name}
                                    </span>` :
                                    `<div class="badge ${user.role === 'leader' ? 'badge-leader' : 
                                                      user.role === 'staff' ? 'badge-staff' : 'badge-member'}"
                                         style="margin-bottom: 5px;">
                                        ${user.role.toUpperCase()}
                                    </div>`
                                }
                                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">
                                    @${user.gamertag}
                                </div>
                            </div>
                            <p style="opacity: 0.8; font-size: 14px;">Joined: ${joinDate} | Last Login: ${lastLogin}</p>
                        </div>
                        
                        <!-- TAP SYSTEM -->
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-hand-pointer"></i> Earn TC by Tapping
                            </div>
                            <div style="text-align: center; padding: 20px;">
                                <div id="tapButton" style="font-size: 72px; margin-bottom: 20px; color: #FFD700; cursor: pointer;" 
                                     onclick="handleTap()">
                                    <i class="fas fa-fingerprint"></i>
                                </div>
                                <h3>Tap Here!</h3>
                                <p>Every 100 taps = 5 TC</p>
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 20px 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>Total Taps:</span>
                                        <strong>${tapCount}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                        <span>TC from Taps:</span>
                                        <strong style="color: #FFD700;">${tcFromTaps} TC</strong>
                                    </div>
                                    <div style="margin-top: 15px;">
                                        <div class="progress-container">
                                            <div class="progress-bar" style="width: ${tapProgress}%"></div>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                            <span>Progress to next 5 TC</span>
                                            <span>${tapProgress}/100</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-coins"></i> Team Cash
                            </div>
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; font-weight: bold; color: #FFD700; margin-bottom: 10px;">
                                    ${user.teamCash} TC
                                </div>
                                <p>Total TC from Taps: ${tcFromTaps} TC</p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-user-circle"></i> Personal Information
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <div class="privacy-toggle">
                                    <span>Gamertag</span>
                                    <span>${user.gamertag}</span>
                                </div>
                                
                                <div class="privacy-toggle">
                                    <span>Discord</span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span>${user.discord}</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" ${user.privacy?.discord ? 'checked' : ''} 
                                                   onchange="togglePrivacy('discord', this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="privacy-toggle">
                                    <span>WhatsApp</span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span>${user.whatsapp}</span>
                                        <label class="toggle-switch">
                                            <input type="checkbox" ${user.privacy?.whatsapp ? 'checked' : ''} 
                                                   onchange="togglePrivacy('whatsapp', this.checked)">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">About Me</label>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span>Show to others</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" ${user.privacy?.about ? 'checked' : ''} 
                                               onchange="togglePrivacy('about', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <textarea class="form-control" id="aboutText" rows="3" placeholder="Tell us about yourself...">${user.about || ''}</textarea>
                                <button class="btn" onclick="saveAbout()" style="margin-top: 10px; width: auto;">
                                    <i class="fas fa-save"></i> Save
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderBuyTC() {
                const user = this.currentUser;
                const purchaseRequests = Database.getPurchaseRequests(user.id);
                const pendingRequests = purchaseRequests.filter(r => r.status === 'pending');
                
                return `
                    <div class="animate-fade-in">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-shopping-cart"></i> Beli TC Cepat dari Leader
                            </div>
                            
                            <div style="margin-bottom: 20px; background: rgba(255,215,0,0.1); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,215,0,0.3);">
                                <h4 style="color: #FFD700; margin-bottom: 10px;"><i class="fas fa-clock"></i> Jam Kerja Leader</h4>
                                <p style="margin: 0;">19.00 - 22.00 WIB (Setiap Hari)</p>
                                <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.8;">Permintaan di luar jam kerja akan diproses keesokan harinya.</p>
                            </div>
                            
                            <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 20px;">
                                <div style="font-size: 48px; color: #FFD700; margin-bottom: 10px;">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <h3>Harga TC</h3>
                                <p style="font-size: 24px; color: #FFD700;">100 TC = Rp 1.000.000 (Game Money)</p>
                                <p style="opacity: 0.8;">Minimal pembelian: 100 TC</p>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Jumlah TC yang ingin dibeli:</label>
                                <input type="number" class="form-control" id="buyAmount" min="100" step="100" value="100" oninput="updatePrice()">
                                <div style="font-size: 14px; margin-top: 5px; opacity: 0.8;">Kelipatan 100 TC</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Total Harga (Game Money):</label>
                                <input type="text" class="form-control" id="totalPrice" readonly value="1.000.000">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Metode Pembayaran:</label>
                                <select class="form-control" id="paymentMethod">
                                    <option value="game_money">Transfer Game Money (dalam game)</option>
                                </select>
                            </div>
                            
                            <button class="btn btn-success" onclick="submitPurchaseRequest()">
                                <i class="fas fa-paper-plane"></i> Ajukan Permintaan Pembelian
                            </button>
                            
                            ${pendingRequests.length > 0 ? `
                                <div style="margin-top: 30px;">
                                    <h4><i class="fas fa-clock"></i> Permintaan Pending (${pendingRequests.length})</h4>
                                    ${pendingRequests.map(req => `
                                        <div style="background: rgba(255,215,0,0.1); padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid rgba(255,215,0,0.3);">
                                            <div style="display: flex; justify-content: space-between;">
                                                <div>
                                                    <strong>${req.amount} TC</strong>
                                                    <div style="font-size: 12px; opacity: 0.8;">Rp ${req.totalPrice.toLocaleString()}</div>
                                                </div>
                                                <span class="badge badge-warning" style="font-size: 11px;">Menunggu Leader</span>
                                            </div>
                                            <div style="font-size: 12px; margin-top: 10px;">
                                                ${new Date(req.createdAt).toLocaleString()}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            renderLeaderboard() {
                const users = Database.getUsers()
                    .filter(user => user.role !== 'leader')
                    .sort((a, b) => b.teamCash - a.teamCash);
                
                const leader = Database.getUsers().find(user => user.role === 'leader');
                
                return `
                    <div class="card animate-fade-in">
                        <div class="card-header">
                            <i class="fas fa-trophy"></i> Member Ranking
                        </div>
                        
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-value">${users.length}</div>
                                <div class="stat-label">Active Members</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${users.reduce((sum, user) => sum + user.teamCash, 0)}</div>
                                <div class="stat-label">Total TC</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${users.reduce((sum, user) => sum + (user.tapCount || 0), 0)}</div>
                                <div class="stat-label">Total Taps</div>
                            </div>
                        </div>
                        
                        ${leader ? `
                            <div style="background: rgba(255,215,0,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.3);">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 60px; height: 60px; background: linear-gradient(45deg, #FFD700, #FFA500); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #000;">
                                        <i class="fas fa-crown"></i>
                                    </div>
                                    <div>
                                        <h4 style="color: #FFD700;">${leader.nickname || leader.gamertag}</h4>
                                        <div style="display: flex; align-items: center; gap: 10px; margin: 5px 0;">
                                            <span class="badge badge-leader">LEADER</span>
                                            <span style="font-weight: bold; color: #FFD700;">${leader.teamCash} TC</span>
                                        </div>
                                        <p style="opacity: 0.8; font-size: 14px; margin: 0;">@${leader.gamertag}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Member</th>
                                        <th>Team Cash</th>
                                        <th>Taps</th>
                                        <th>Badge</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${users.map((user, index) => {
                                        return `
                                            <tr>
                                                <td>
                                                    ${index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : `#${index + 1}`}
                                                </td>
                                                <td>
                                                    <div>
                                                        <strong style="cursor: pointer; color: #FFD700;" onclick="AppState.viewMemberProfile(${user.id})">
                                                            ${user.nickname || user.gamertag}
                                                        </strong>
                                                        <div style="font-size: 12px; opacity: 0.7; margin-top: 2px;">
                                                            @${user.gamertag}
                                                        </div>
                                                    </div>
                                                </td>
                                                <td style="color: #FFD700; font-weight: bold;">
                                                    ${user.teamCash} TC
                                                </td>
                                                <td>${user.tapCount || 0}</td>
                                                <td>
                                                    ${user.customBadge ? 
                                                        `<span class="badge" style="background: ${user.customBadge.color}; font-size: 10px; padding: 4px 8px;">
                                                            ${user.customBadge.name}
                                                        </span>` : 
                                                        '<span style="opacity: 0.5;">-</span>'
                                                    }
                                                </td>
                                                <td>
                                                    <button class="btn" onclick="AppState.viewMemberProfile(${user.id})" style="width: auto; padding: 5px 10px; font-size: 12px;">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            },

            renderTokens() {
                if (this.currentUser.role !== 'leader') {
                    return `
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-lock"></i> Access Denied
                            </div>
                            <p style="text-align: center; padding: 40px;">Only leaders can manage tokens.</p>
                        </div>
                    `;
                }

                const tokens = Database.getTokens();
                const purchaseRequests = Database.getPurchaseRequests();
                const pendingRequests = purchaseRequests.filter(r => r.status === 'pending');
                const availableTokens = tokens.filter(t => !t.used);
                const usedTokens = tokens.filter(t => t.used);
                
                return `
                    <div class="animate-fade-in">
                        ${pendingRequests.length > 0 ? `
                            <div class="card" style="margin-bottom: 20px; background: rgba(255,215,0,0.1); border-color: rgba(255,215,0,0.3);">
                                <div class="card-header">
                                    <i class="fas fa-shopping-cart"></i> Purchase Requests (${pendingRequests.length})
                                </div>
                                <div>
                                    ${pendingRequests.map(req => {
                                        const user = Database.findUserById(req.userId);
                                        return `
                                            <div style="padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong>${req.amount} TC</strong>
                                                        <div style="font-size: 12px; opacity: 0.8;">
                                                            Dari: ${user?.gamertag || 'Unknown'} | Rp ${req.totalPrice.toLocaleString()}
                                                        </div>
                                                        <div style="font-size: 12px; margin-top: 5px;">
                                                            ${new Date(req.createdAt).toLocaleString()}
                                                        </div>
                                                    </div>
                                                    <div style="display: flex; gap: 10px;">
                                                        <button class="btn btn-success" onclick="completePurchase(${req.id})" style="width: auto; padding: 5px 10px; font-size: 12px;">
                                                            <i class="fas fa-check"></i> Selesai
                                                        </button>
                                                        <button class="btn btn-danger" onclick="cancelPurchase(${req.id})" style="width: auto; padding: 5px 10px; font-size: 12px;">
                                                            <i class="fas fa-times"></i> Batal
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-key"></i> Manage Tokens
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Create New Token</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" class="form-control" id="newToken" placeholder="ELITE2024" required>
                                    <button class="btn" onclick="createToken()" style="width: auto;">
                                        Create Token
                                    </button>
                                </div>
                                <small style="opacity: 0.7;">Token hanya bisa digunakan sekali oleh satu member</small>
                            </div>
                            
                            <div style="margin-top: 20px;">
                                <h4>Available Tokens (${availableTokens.length})</h4>
                                ${availableTokens.length === 0 ? 
                                    `<p style="text-align: center; padding: 20px; opacity: 0.7;">No tokens available</p>` :
                                    availableTokens.map(token => `
                                        <div style="background: rgba(0, 184, 148, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid rgba(0, 184, 148, 0.3);">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <strong style="font-family: monospace;">${token.token}</strong>
                                                    <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                                                        Created: ${new Date(token.createdAt).toLocaleDateString()}
                                                    </div>
                                                </div>
                                                <span class="badge badge-member" style="font-size: 11px;">Available</span>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                            
                            ${usedTokens.length > 0 ? `
                                <div style="margin-top: 20px;">
                                    <h4>Used Tokens (${usedTokens.length})</h4>
                                    ${usedTokens.map(token => {
                                        const user = Database.findUserById(token.usedBy);
                                        return `
                                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <strong style="font-family: monospace;">${token.token}</strong>
                                                        <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                                                            Used by: ${user?.gamertag || 'Unknown'} | ${new Date(token.usedAt).toLocaleDateString()}
                                                        </div>
                                                    </div>
                                                    <span class="badge" style="background: rgba(255,255,255,0.2); font-size: 11px;">Used</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },

            renderMarket() {
                const messages = Database.getMarketplaceMessages();
                
                return `
                    <div class="animate-fade-in">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-coins"></i> Marketplace
                            </div>
                            
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 10px; color: #FFD700;">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <h3 style="margin-bottom: 10px;">Team Cash Marketplace</h3>
                                <p style="margin-bottom: 20px; opacity: 0.8;">Buy and sell Team Cash with other members</p>
                                
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                                    <div style="background: rgba(0, 184, 148, 0.1); padding: 20px; border-radius: 10px; border: 1px solid rgba(0, 184, 148, 0.3);">
                                        <div style="font-size: 24px; color: #00b894; margin-bottom: 10px;">
                                            <i class="fas fa-shopping-cart"></i>
                                        </div>
                                        <h4>Buy TC</h4>
                                        <p style="font-size: 14px; opacity: 0.8;">Find sellers in chat</p>
                                    </div>
                                    <div style="background: rgba(255, 82, 82, 0.1); padding: 20px; border-radius: 10px; border: 1px solid rgba(255, 82, 82, 0.3);">
                                        <div style="font-size: 24px; color: #ff5252; margin-bottom: 10px;">
                                            <i class="fas fa-money-bill-wave"></i>
                                        </div>
                                        <h4>Sell TC</h4>
                                        <p style="font-size: 14px; opacity: 0.8;">Find buyers in chat</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Marketplace Chat -->
                        <div class="marketplace-chat">
                            <div class="chat-header">
                                <h3><i class="fas fa-comments"></i> Marketplace Chat</h3>
                                <div style="font-size: 14px; opacity: 0.8;">
                                    Use @username to mention members
                                </div>
                            </div>
                            
                            <div class="chat-messages" id="marketplaceMessages">
                                ${messages.map(msg => {
                                    const sender = Database.findUserById(msg.senderId);
                                    const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                    const isCurrentUser = this.currentUser && msg.senderId === this.currentUser.id;
                                    
                                    return `
                                        <div class="message ${isCurrentUser ? 'sent' : 'received'}">
                                            <div class="message-header">
                                                <span class="message-sender" onclick="AppState.viewMemberProfile(${msg.senderId})">
                                                    ${sender?.gamertag || 'Unknown'}
                                                </span>
                                                <span class="message-time">${time}</span>
                                            </div>
                                            <div class="message-content">
                                                ${msg.content}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div class="chat-input-container">
                                <input type="text" class="chat-input" id="marketplaceMessage" placeholder="Type your message... Use @username to mention" onkeypress="if(event.key === 'Enter') sendMarketplaceMessage()">
                                <button class="btn" onclick="sendMarketplaceMessage()" style="width: auto;">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderTeam() {
                const users = Database.getUsers();
                const currentUserId = this.currentUser?.id;
                
                return `
                    <div class="card animate-fade-in">
                        <div class="card-header">
                            <i class="fas fa-users"></i> Team Members (${users.length})
                        </div>
                        
                        <div style="display: grid; gap: 20px; margin-top: 20px;">
                            ${users.filter(user => user.id !== currentUserId).map(user => {
                                const joinDate = new Date(user.createdAt).toLocaleDateString();
                                const tapCount = user.tapCount || 0;
                                return `
                                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                                        <div style="display: flex; align-items: center; gap: 15px;">
                                            <div style="width: 60px; height: 60px; background: linear-gradient(45deg, #6a11cb, #2575fc); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" 
                                                 onclick="AppState.viewMemberProfile(${user.id})">
                                                ${user.profileImage ? 
                                                    `<img src="${user.profileImage}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` :
                                                    `<i class="fas fa-user"></i>`
                                                }
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <h4 style="margin: 0; cursor: pointer;" onclick="AppState.viewMemberProfile(${user.id})">
                                                        ${user.nickname || user.gamertag}
                                                    </h4>
                                                    <div style="display: flex; align-items: center; gap: 10px;">
                                                        ${user.customBadge ? 
                                                            `<span class="badge" style="background: ${user.customBadge.color}; font-size: 10px; padding: 4px 8px;">
                                                                ${user.customBadge.name}
                                                            </span>` : ''
                                                        }
                                                        <span class="badge ${user.role === 'leader' ? 'badge-leader' : 
                                                                          user.role === 'staff' ? 'badge-staff' : 'badge-member'}"
                                                              style="font-size: 10px; padding: 4px 8px;">
                                                            ${user.role.toUpperCase()}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style="font-size: 12px; opacity: 0.7; margin: 5px 0;">
                                                    @${user.gamertag}
                                                </div>
                                                ${user.about && user.privacy?.about ? 
                                                    `<p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.8;">${user.about}</p>` : ''
                                                }
                                                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 12px; opacity: 0.7;">
                                                    <span>TC: ${user.teamCash}</span>
                                                    <span>Taps: ${tapCount}</span>
                                                </div>
                                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                                    <button class="btn btn-success" onclick="openTransferModal(${user.id}, '${user.gamertag}')" style="padding: 8px 16px; font-size: 14px; width: auto;">
                                                        <i class="fas fa-money-bill-wave"></i> Pay
                                                    </button>
                                                    ${AppState.currentUser?.role === 'leader' ? `
                                                        <button class="btn" onclick="openNicknameModal(${user.id}, '${user.gamertag}')" style="padding: 8px 16px; font-size: 14px; width: auto;">
                                                            <i class="fas fa-tag"></i> Nickname
                                                        </button>
                                                        <button class="btn btn-purple" onclick="openBadgeModal(${user.id}, '${user.gamertag}')" style="padding: 8px 16px; font-size: 14px; width: auto;">
                                                            <i class="fas fa-crown"></i> Badge
                                                        </button>
                                                    ` : ''}
                                                    <button class="btn btn-secondary" onclick="AppState.viewMemberProfile(${user.id})" style="padding: 8px 16px; font-size: 14px; width: auto;">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            renderMemberProfile(memberId) {
                const member = Database.findUserById(memberId);
                if (!member) return '<p>Member not found</p>';
                
                const isOwnProfile = this.currentUser && this.currentUser.id === memberId;
                const isLeader = this.currentUser && this.currentUser.role === 'leader';
                const joinDate = new Date(member.createdAt).toLocaleDateString();
                const tapCount = member.tapCount || 0;
                const tcFromTaps = Math.floor(tapCount / 100) * 5;
                
                return `
                    <div class="animate-fade-in">
                        <button class="btn btn-secondary" onclick="AppState.viewingMemberId = null; AppState.navigateSection('team');" style="margin-bottom: 20px; width: auto;">
                            <i class="fas fa-arrow-left"></i> Back to Team
                        </button>
                        
                        <div class="card" style="text-align: center;">
                            <div class="profile-avatar">
                                ${member.profileImage ? 
                                    `<img src="${member.profileImage}" alt="Profile">` : 
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                            <h2 style="margin-bottom: 5px;">${member.nickname || member.gamertag}</h2>
                            <div style="margin-bottom: 10px;">
                                ${member.customBadge ? 
                                    `<span class="badge" style="background: ${member.customBadge.color}; color: ${member.customBadge.type === 'custom' ? '#000' : 'white'}">
                                        ${member.customBadge.name}
                                    </span>` :
                                    `<div class="badge ${member.role === 'leader' ? 'badge-leader' : 
                                                      member.role === 'staff' ? 'badge-staff' : 'badge-member'}"
                                         style="margin-bottom: 5px;">
                                        ${member.role.toUpperCase()}
                                    </div>`
                                }
                                <div style="font-size: 14px; opacity: 0.7; margin-top: 5px;">
                                    @${member.gamertag}
                                </div>
                            </div>
                            <p style="opacity: 0.8; font-size: 14px;">Member since: ${joinDate}</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-coins"></i> Team Cash
                            </div>
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; font-weight: bold; color: #FFD700; margin-bottom: 10px;">
                                    ${member.teamCash} TC
                                </div>
                                <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                                    <div>
                                        <div style="font-size: 24px;">${tapCount}</div>
                                        <div style="font-size: 12px; opacity: 0.8;">Total Taps</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; color: #FFD700;">${tcFromTaps}</div>
                                        <div style="font-size: 12px; opacity: 0.8;">TC from Taps</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-info-circle"></i> About
                            </div>
                            <div style="padding: 20px;">
                                ${member.about && member.privacy?.about ? 
                                    `<p style="line-height: 1.6;">${member.about}</p>` :
                                    '<p style="opacity: 0.7; text-align: center;">This member has not set an about section or it is private.</p>'
                                }
                                
                                ${!isOwnProfile ? `
                                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                                        <button class="btn btn-success" onclick="openTransferModal(${member.id}, '${member.gamertag}')">
                                            <i class="fas fa-money-bill-wave"></i> Pay TC
                                        </button>
                                        ${isLeader ? `
                                            <button class="btn" onclick="openNicknameModal(${member.id}, '${member.gamertag}')">
                                                <i class="fas fa-tag"></i> Give Nickname
                                            </button>
                                            <button class="btn btn-purple" onclick="openBadgeModal(${member.id}, '${member.gamertag}')">
                                                <i class="fas fa-crown"></i> Give Badge
                                            </button>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            },

            // Event Handlers
            handleLogin() {
                SoundSystem.playClick();
                
                const gamertag = document.getElementById('loginGamertag').value;
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');
                
                if (!errorDiv) return;
                
                errorDiv.style.display = 'none';
                
                if (!gamertag || !password) {
                    errorDiv.textContent = 'Please fill in all fields';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const user = Database.findUserByGamertag(gamertag);
                
                if (!user || user.password !== password) {
                    errorDiv.textContent = 'Invalid gamertag or password';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                user.lastLogin = new Date().toISOString();
                Database.updateUser(user.id, { lastLogin: user.lastLogin });
                
                this.currentUser = user;
                this.saveUserSession();
                this.navigate('dashboard');
            },

            handleRegister() {
                SoundSystem.playClick();
                
                const gamertag = document.getElementById('registerGamertag').value;
                const discord = document.getElementById('registerDiscord').value;
                const whatsapp = document.getElementById('registerWhatsapp').value;
                const token = document.getElementById('registerToken').value;
                const password = document.getElementById('registerPassword').value;
                
                const errorDiv = document.getElementById('registerError');
                
                if (!errorDiv) return;
                
                errorDiv.style.display = 'none';
                
                if (!gamertag || !discord || !whatsapp || !token || !password) {
                    errorDiv.textContent = 'Please fill in all fields';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                if (password.length < 8) {
                    errorDiv.textContent = 'Password must be at least 8 characters';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                if (!Database.validateToken(token)) {
                    errorDiv.textContent = 'Invalid or used token';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                if (Database.findUserByGamertag(gamertag)) {
                    errorDiv.textContent = 'Gamertag already taken';
                    errorDiv.style.display = 'block';
                    return;
                }
                
                const newUser = {
                    gamertag,
                    discord,
                    whatsapp,
                    password,
                    role: 'member'
                };
                
                const userId = Database.addUser(newUser);
                Database.markTokenUsed(token, userId);
                
                alert('Registration successful! You can now login.');
                this.navigate('login');
            },

            logout() {
                this.currentUser = null;
                this.saveUserSession();
                document.getElementById('bottomNav').style.display = 'none';
                this.navigate('home');
            }
        };

        // ============================================
        // GLOBAL FUNCTIONS
        // ============================================

        // Password Strength Checker
        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            if (!strengthDiv) return;
            
            if (!password) {
                strengthDiv.textContent = '';
                strengthDiv.className = 'password-strength';
                return;
            }
            
            let strength = 0;
            let message = '';
            let className = '';
            
            if (password.length >= 8) strength++;
            if (password.length >= 12) strength++;
            
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            
            if (strength <= 2) {
                message = 'Password terlalu mudah';
                className = 'strength-weak';
            } else if (strength <= 4) {
                message = 'Password mudah';
                className = 'strength-fair';
            } else if (strength <= 6) {
                message = 'Password sulit';
                className = 'strength-good';
            } else {
                message = 'Password terlalu susah';
                className = 'strength-strong';
            }
            
            strengthDiv.textContent = message;
            strengthDiv.className = `password-strength ${className}`;
        }

        // Tap System
        function handleTap() {
            if (!AppState.currentUser || AppState.tapCooldown) return;
            
            SoundSystem.playClick();
            AppState.tapCooldown = true;
            
            const result = Database.addTap(AppState.currentUser.id);
            
            if (result.success && result.tcEarned > 0) {
                Database.addNotification({
                    userId: AppState.currentUser.id,
                    type: 'tap_reward',
                    message: ` Anda mendapatkan ${result.tcEarned} TC dari tapping!`,
                    read: false,
                    timestamp: new Date().toISOString()
                });
            }
            
            AppState.currentUser.tapCount = result.tapCount;
            AppState.currentUser.teamCash = result.totalTC;
            AppState.saveUserSession();
            
            AppState.render();
            
            setTimeout(() => {
                AppState.tapCooldown = false;
            }, 100);
        }

        // Purchase System
        function updatePrice() {
            const amountInput = document.getElementById('buyAmount');
            const totalPriceInput = document.getElementById('totalPrice');
            
            if (!amountInput || !totalPriceInput) return;
            
            const amount = parseInt(amountInput.value) || 100;
            const price = (amount / 100) * 1000000;
            totalPriceInput.value = price.toLocaleString('id-ID');
        }

        function submitPurchaseRequest() {
            if (!AppState.currentUser) return;
            
            SoundSystem.playClick();
            
            const amountInput = document.getElementById('buyAmount');
            const amount = parseInt(amountInput.value);
            
            if (!amount || amount < 100 || amount % 100 !== 0) {
                alert('Jumlah TC harus kelipatan 100 dan minimal 100 TC');
                return;
            }
            
            const paymentMethod = document.getElementById('paymentMethod').value;
            const totalPrice = (amount / 100) * 1000000;
            
            const request = {
                userId: AppState.currentUser.id,
                gamertag: AppState.currentUser.gamertag,
                amount: amount,
                totalPrice: totalPrice,
                paymentMethod: paymentMethod,
                status: 'pending'
            };
            
            Database.addPurchaseRequest(request);
            
            alert('Permintaan pembelian telah dikirim. Leader akan memproses dalam jam kerja (19.00-22.00 WIB).');
            
            AppState.render();
        }

        function completePurchase(requestId) {
            SoundSystem.playClick();
            const success = Database.completePurchase(requestId);
            if (success) {
                alert('Purchase completed! TC telah ditambahkan ke user.');
            } else {
                alert('Failed to complete purchase.');
            }
            AppState.render();
        }

        function cancelPurchase(requestId) {
            SoundSystem.playClick();
            Database.updatePurchaseRequest(requestId, { 
                status: 'cancelled',
                cancelledAt: new Date().toISOString()
            });
            
            alert('Purchase cancelled.');
            AppState.render();
        }

        // Nickname and Badge Functions
        function openNicknameModal(userId, username) {
            SoundSystem.playClick();
            const modal = document.getElementById('nicknameModal');
            const form = document.getElementById('nicknameForm');
            
            const user = Database.findUserById(userId);
            
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Member:</label>
                    <input type="text" class="form-control" value="${username}" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Julukan (Nickname):</label>
                    <input type="text" class="form-control" id="nicknameInput" value="${user.nickname || ''}" placeholder="Masukkan julukan...">
                </div>
                
                <button class="btn btn-success" onclick="setNickname(${userId})" style="width: auto;">
                    <i class="fas fa-save"></i> Set Nickname
                </button>
            `;
            
            modal.classList.add('active');
        }

        function closeNicknameModal() {
            SoundSystem.playClick();
            document.getElementById('nicknameModal').classList.remove('active');
        }

        function setNickname(userId) {
            SoundSystem.playClick();
            const nickname = document.getElementById('nicknameInput').value.trim();
            
            if (!nickname) {
                alert('Masukkan julukan terlebih dahulu!');
                return;
            }
            
            Database.updateUser(userId, { nickname });
            
            const user = Database.findUserById(userId);
            if (user) {
                Database.addNotification({
                    userId: userId,
                    type: 'nickname_given',
                    message: `Leader memberikan julukan "${nickname}" kepada Anda`,
                    read: false,
                    timestamp: new Date().toISOString()
                });
            }
            
            alert('Julukan berhasil diberikan!');
            closeNicknameModal();
            
            AppState.render();
        }

        function openBadgeModal(userId, username) {
            SoundSystem.playClick();
            const modal = document.getElementById('badgeModal');
            const form = document.getElementById('badgeForm');
            
            const user = Database.findUserById(userId);
            
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Member:</label>
                    <input type="text" class="form-control" value="${username}" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nama Badge:</label>
                    <input type="text" class="form-control" id="badgeNameInput" value="${user.customBadge?.name || ''}" placeholder="VIP, ELITE, etc" maxlength="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Warna Badge:</label>
                    <input type="color" class="form-control" id="badgeColorInput" value="${user.customBadge?.color || '#FFD700'}">
                </div>
                
                <button class="btn btn-purple" onclick="setCustomBadge(${userId})" style="width: auto;">
                    <i class="fas fa-crown"></i> Set Custom Badge
                </button>
            `;
            
            modal.classList.add('active');
        }

        function closeBadgeModal() {
            SoundSystem.playClick();
            document.getElementById('badgeModal').classList.remove('active');
        }

        function setCustomBadge(userId) {
            SoundSystem.playClick();
            const badgeName = document.getElementById('badgeNameInput').value.trim();
            const badgeColor = document.getElementById('badgeColorInput').value;
            
            if (!badgeName) {
                alert('Masukkan nama badge terlebih dahulu!');
                return;
            }
            
            const customBadge = {
                type: 'custom',
                name: badgeName.toUpperCase(),
                color: badgeColor
            };
            
            Database.updateUser(userId, { customBadge });
            
            const user = Database.findUserById(userId);
            if (user) {
                Database.addNotification({
                    userId: userId,
                    type: 'badge_given',
                    message: `Leader memberikan custom badge "${badgeName}" kepada Anda`,
                    read: false,
                    timestamp: new Date().toISOString()
                });
            }
            
            alert('Custom badge berhasil diberikan!');
            closeBadgeModal();
            
            AppState.render();
        }

        // Existing functions
        function showLogoutConfirmation() {
            SoundSystem.playClick();
            document.getElementById('logoutConfirmation').classList.add('active');
        }

        function confirmLogout() {
            SoundSystem.playClick();
            AppState.logout();
            document.getElementById('logoutConfirmation').classList.remove('active');
        }

        function cancelLogout() {
            SoundSystem.playClick();
            document.getElementById('logoutConfirmation').classList.remove('active');
        }

        function openTransferModal(toUserId, toUsername) {
            SoundSystem.playClick();
            const modal = document.getElementById('transferModal');
            const form = document.getElementById('transferForm');
            
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Transfer to:</label>
                    <input type="text" class="form-control" value="${toUsername}" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Amount (TC):</label>
                    <input type="number" class="form-control" id="transferAmount" min="1" max="${AppState.currentUser.teamCash}" placeholder="Enter amount">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Note (optional):</label>
                    <input type="text" class="form-control" id="transferNote" placeholder="Add a note...">
                </div>
                
                <button class="btn btn-success" onclick="processTransfer(${toUserId})" style="width: auto;">
                    <i class="fas fa-paper-plane"></i> Send Transfer
                </button>
            `;
            
            modal.classList.add('active');
        }

        function closeModal() {
            SoundSystem.playClick();
            document.getElementById('transferModal').classList.remove('active');
        }

        function processTransfer(toUserId) {
            SoundSystem.playClick();
            const amount = parseInt(document.getElementById('transferAmount').value);
            const note = document.getElementById('transferNote').value || '';
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            if (amount > AppState.currentUser.teamCash) {
                alert('Insufficient Team Cash');
                return;
            }
            
            const result = Database.transferCash(AppState.currentUser.id, toUserId, amount, note);
            
            if (result.success) {
                alert(`Successfully transferred ${amount} TC!`);
                closeModal();
                
                AppState.currentUser.teamCash -= amount;
                AppState.saveUserSession();
                
                AppState.render();
            } else {
                alert(result.message);
            }
        }

        function sendMarketplaceMessage() {
            const input = document.getElementById('marketplaceMessage');
            const content = input.value.trim();
            
            if (!content || !AppState.currentUser) {
                alert('Please enter a message');
                return;
            }
            
            SoundSystem.playClick();
            
            Database.addMessage({
                senderId: AppState.currentUser.id,
                senderName: AppState.currentUser.gamertag,
                content: content,
                type: 'marketplace'
            });
            
            input.value = '';
            
            const chatMessages = document.getElementById('marketplaceMessages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            AppState.render();
        }

        function createToken() {
            SoundSystem.playClick();
            
            if (!AppState.currentUser || AppState.currentUser.role !== 'leader') {
                alert('Only leaders can create tokens');
                return;
            }
            
            const tokenInput = document.getElementById('newToken');
            const tokenValue = tokenInput.value.trim();
            
            if (!tokenValue) {
                alert('Please enter a token value');
                return;
            }
            
            Database.addToken({
                token: tokenValue,
                createdBy: AppState.currentUser.id
            });
            
            tokenInput.value = '';
            alert('Token created successfully!');
            AppState.render();
        }

        function togglePrivacy(field, enabled) {
            SoundSystem.playClick();
            if (!AppState.currentUser) return;
            
            const privacy = { ...AppState.currentUser.privacy };
            privacy[field] = enabled;
            Database.updateUser(AppState.currentUser.id, { privacy });
            AppState.currentUser.privacy = privacy;
            AppState.saveUserSession();
        }

        function saveAbout() {
            SoundSystem.playClick();
            if (!AppState.currentUser) return;
            
            const aboutText = document.getElementById('aboutText').value;
            Database.updateUser(AppState.currentUser.id, { about: aboutText });
            AppState.currentUser.about = aboutText;
            AppState.saveUserSession();
            alert('About saved!');
            AppState.render();
        }

        function uploadProfileImage() {
            SoundSystem.playClick();
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const imageData = event.target.result;
                        Database.updateUser(AppState.currentUser.id, { profileImage: imageData });
                        AppState.currentUser.profileImage = imageData;
                        AppState.saveUserSession();
                        AppState.render();
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function markNotificationRead(notificationId) {
            SoundSystem.playClick();
            Database.markNotificationRead(notificationId);
            AppState.render();
        }

        function markAllNotificationsRead() {
            SoundSystem.playClick();
            if (!AppState.currentUser) return;
            
            Database.markAllNotificationsRead(AppState.currentUser.id);
            AppState.render();
        }

        function toggleNotifications() {
            SoundSystem.playClick();
            AppState.navigateSection('profile');
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', function() {
            AppState.init();
        });

        window.AppState = AppState;
        window.checkPasswordStrength = checkPasswordStrength;
        window.handleTap = handleTap;
        window.updatePrice = updatePrice;
        window.submitPurchaseRequest = submitPurchaseRequest;
        window.completePurchase = completePurchase;
        window.cancelPurchase = cancelPurchase;
        window.openNicknameModal = openNicknameModal;
        window.closeNicknameModal = closeNicknameModal;
        window.setNickname = setNickname;
        window.openBadgeModal = openBadgeModal;
        window.closeBadgeModal = closeBadgeModal;
        window.setCustomBadge = setCustomBadge;
        window.showLogoutConfirmation = showLogoutConfirmation;
        window.confirmLogout = confirmLogout;
        window.cancelLogout = cancelLogout;
        window.openTransferModal = openTransferModal;
        window.closeModal = closeModal;
        window.processTransfer = processTransfer;
        window.sendMarketplaceMessage = sendMarketplaceMessage;
        window.createToken = createToken;
        window.togglePrivacy = togglePrivacy;
        window.saveAbout = saveAbout;
        window.uploadProfileImage = uploadProfileImage;
        window.markNotificationRead = markNotificationRead;
        window.markAllNotificationsRead = markAllNotificationsRead;
        window.toggleNotifications = toggleNotifications;
    </script>
</body>
</html>
